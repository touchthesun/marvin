<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marvin Dashboard (Minimal)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    .panel {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 8px 16px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #3367d6;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f8f8;
      border-left: 4px solid #4285f4;
    }
    .error {
      border-left-color: #ea4335;
      background-color: #fdedea;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow: auto;
      max-height: 300px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Marvin Dashboard (Minimal Version)</h1>
    <p>This is a minimal version of the dashboard to diagnose performance issues.</p>
    
    <div class="panel">
      <h2>Diagnostic Tools</h2>
      <button id="check-memory">Check Memory Usage</button>
      <button id="test-logger">Test Logger</button>
      <button id="test-storage">Test Storage</button>
      <button id="test-navigation">Test Navigation</button>
    </div>
    
    <div class="panel">
      <h2>Component Tests</h2>
      <button id="load-overview">Load Overview Panel</button>
      <button id="load-capture">Load Capture Panel</button>
      <button id="load-knowledge">Load Knowledge Panel</button>
      <button id="load-settings">Load Settings Panel</button>
    </div>
    
    <div id="status-container" class="status">
      <h3>Status</h3>
      <div id="status-message">Ready for diagnostics</div>
    </div>
    
    <div id="result-container" class="panel">
      <h3>Results</h3>
      <pre id="result-output"></pre>
    </div>
  </div>

  <script type="module">
    // Import the standalone DiagnosticTools class
    import { DiagnosticTools } from '../shared/utils/DiagnosticTools.js';
    
    // Helper functions
    function updateStatus(message, isError = false) {
      const statusMessage = document.getElementById('status-message');
      const container = document.getElementById('status-container');
      
      statusMessage.textContent = message;
      
      if (isError) {
        container.classList.add('error');
      } else {
        container.classList.remove('error');
      }
    }
    
    function logResult(message) {
      const resultOutput = document.getElementById('result-output');
      const timestamp = new Date().toISOString();
      resultOutput.textContent += `[${timestamp}] ${message}\n`;
      
      // Auto-scroll to bottom
      resultOutput.scrollTop = resultOutput.scrollHeight;
    }
    
    // Initialize DiagnosticTools
    let diagnostics;
    
    async function initialize() {
      try {
        // Create DiagnosticTools instance
        diagnostics = new DiagnosticTools();
        updateStatus('DiagnosticTools initialized successfully');
        logResult('DiagnosticTools initialized successfully');
        setupEventListeners();
      } catch (error) {
        console.error('Error initializing DiagnosticTools:', error);
        updateStatus(`Error initializing DiagnosticTools: ${error.message}`, true);
        logResult(`ERROR: Failed to initialize DiagnosticTools: ${error.message}`);
        initializeFallback();
      }
    }
    
    // Initialize with fallback if DiagnosticTools fails
    function initializeFallback() {
      // Define basic diagnostic tools class
      class BasicDiagnosticTools {
        constructor() {
          console.log('Using basic diagnostic tools');
        }
        
        takeMemorySnapshot() {
          if (performance && performance.memory) {
            return {
              usedJSHeapSize: performance.memory.usedJSHeapSize,
              totalJSHeapSize: performance.memory.totalJSHeapSize,
              jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
            };
          }
          return null;
        }
        
        async testModuleLoading(modulePath) {
          try {
            const startTime = performance.now();
            const module = await import(modulePath);
            const endTime = performance.now();
            
            return {
              success: true,
              loadTime: endTime - startTime,
              exports: Object.keys(module)
            };
          } catch (error) {
            return {
              success: false,
              error: error.message
            };
          }
        }
      }
      
      // Create fallback instance
      diagnostics = new BasicDiagnosticTools();
      updateStatus('Using basic diagnostic tools (fallback mode)', true);
      logResult('WARNING: Using basic diagnostic tools (fallback mode)');
      setupEventListeners();
    }
    
    // Set up all event listeners
    function setupEventListeners() {
      // Memory check
      document.getElementById('check-memory').addEventListener('click', async () => {
        updateStatus('Checking memory usage...');
        
        try {
          const snapshot = diagnostics.takeMemorySnapshot();
          
          if (snapshot) {
            const usedHeapMB = Math.round(snapshot.usedJSHeapSize / (1024 * 1024));
            const totalHeapMB = Math.round(snapshot.totalJSHeapSize / (1024 * 1024));
            const heapLimitMB = Math.round(snapshot.jsHeapSizeLimit / (1024 * 1024));
            
            logResult(`Memory Usage: ${usedHeapMB}MB / ${totalHeapMB}MB (Limit: ${heapLimitMB}MB)`);
            updateStatus(`Current memory usage: ${usedHeapMB}MB`);
          } else {
            updateStatus('Performance.memory API not available in this browser', true);
            logResult('ERROR: Performance.memory API not available');
          }
        } catch (error) {
          updateStatus(`Error checking memory: ${error.message}`, true);
          logResult(`ERROR: Memory check failed - ${error.message}`);
        }
      });
      
      // Test logger
      document.getElementById('test-logger').addEventListener('click', async () => {
        updateStatus('Testing logger...');
        
        try {
          const result = await diagnostics.testModuleLoading('../shared/utils/log-manager.js');
          
          if (result.success) {
            logResult(`Logger test completed successfully in ${result.loadTime.toFixed(2)}ms`);
            updateStatus('Logger test passed');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          updateStatus(`Logger test failed: ${error.message}`, true);
          logResult(`ERROR: Logger test failed - ${error.message}`);
        }
      });
      
      // Test storage
      document.getElementById('test-storage').addEventListener('click', async () => {
        updateStatus('Testing storage...');
        
        try {
          // Test chrome.storage.local
          const testData = { test_key: 'test_value', timestamp: Date.now() };
          await chrome.storage.local.set({ 'marvin_test_data': testData });
          
          const result = await chrome.storage.local.get('marvin_test_data');
          
          if (result.marvin_test_data && result.marvin_test_data.test_key === 'test_value') {
            logResult('Storage test completed successfully');
            updateStatus('Storage test passed');
          } else {
            throw new Error('Storage data mismatch');
          }
        } catch (error) {
          updateStatus(`Storage test failed: ${error.message}`, true);
          logResult(`ERROR: Storage test failed - ${error.message}`);
        }
      });
      
      // Test navigation
      document.getElementById('test-navigation').addEventListener('click', async () => {
        updateStatus('Testing navigation module...');
        
        try {
          const result = await diagnostics.testModuleLoading('/dashboard/js/components/navigation.js');
          
          if (result.success) {
            logResult(`Navigation module loaded successfully in ${result.loadTime.toFixed(2)}ms`);
            updateStatus('Navigation test passed');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          updateStatus(`Navigation test failed: ${error.message}`, true);
          logResult(`ERROR: Navigation test failed - ${error.message}`);
        }
      });
      
      // Component test functions
      document.getElementById('load-overview').addEventListener('click', async () => {
        updateStatus('Testing Overview panel...');
        
        try {
          const result = await diagnostics.testModuleLoading('dashboard/js/components/overview-panel.js');
          
          if (result.success) {
            logResult(`Overview panel loaded successfully in ${result.loadTime.toFixed(2)}ms`);
            updateStatus('Overview panel loaded successfully');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          updateStatus(`Overview panel load failed: ${error.message}`, true);
          logResult(`ERROR: Overview panel load failed - ${error.message}`);
        }
      });
      
      document.getElementById('load-capture').addEventListener('click', async () => {
        updateStatus('Testing Capture panel...');
        
        try {
          const result = await diagnostics.testModuleLoading('./js/components/capture-panel.js');
          
          if (result.success) {
            logResult(`Capture panel loaded successfully in ${result.loadTime.toFixed(2)}ms`);
            updateStatus('Capture panel loaded successfully');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          updateStatus(`Capture panel load failed: ${error.message}`, true);
          logResult(`ERROR: Capture panel load failed - ${error.message}`);
        }
      });
      
      document.getElementById('load-knowledge').addEventListener('click', async () => {
        updateStatus('Testing Knowledge panel...');
        
        try {
          const result = await diagnostics.testModuleLoading('./js/components/knowledge-panel.js');
          
          if (result.success) {
            logResult(`Knowledge panel loaded successfully in ${result.loadTime.toFixed(2)}ms`);
            updateStatus('Knowledge panel loaded successfully');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          updateStatus(`Knowledge panel load failed: ${error.message}`, true);
          logResult(`ERROR: Knowledge panel load failed - ${error.message}`);
        }
      });
      
      document.getElementById('load-settings').addEventListener('click', async () => {
        updateStatus('Testing Settings panel...');
        
        try {
          const result = await diagnostics.testModuleLoading('./js/components/settings-panel.js');
          
          if (result.success) {
            logResult(`Settings panel loaded successfully in ${result.loadTime.toFixed(2)}ms`);
            updateStatus('Settings panel loaded successfully');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          updateStatus(`Settings panel load failed: ${error.message}`, true);
          logResult(`ERROR: Settings panel load failed - ${error.message}`);
        }
      });
    }
    
    // Initialize when the page loads
    window.addEventListener('load', () => {
      logResult('Diagnostic dashboard loaded');
      
      // Log browser information
      const browserInfo = `
Browser: ${navigator.userAgent}
Platform: ${navigator.platform}
Language: ${navigator.language}
Online: ${navigator.onLine}
`;
      logResult(browserInfo);
      
      // Log extension information
      try {
        const manifest = chrome.runtime.getManifest();
        logResult(`Extension: ${manifest.name} v${manifest.version}`);
      } catch (error) {
        logResult('Could not retrieve extension information');
      }
      
      // Initialize diagnostics
      initialize();
    });
  </script>  
</body>
</html>