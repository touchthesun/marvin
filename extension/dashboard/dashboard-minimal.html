<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marvin Dashboard (Minimal)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    .panel {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 8px 16px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #3367d6;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f8f8;
      border-left: 4px solid #4285f4;
    }
    .error {
      border-left-color: #ea4335;
      background-color: #fdedea;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Marvin Dashboard (Minimal Version)</h1>
    <p>This is a minimal version of the dashboard to diagnose performance issues.</p>
    
    <div class="panel">
      <h2>Diagnostic Tools</h2>
      <button id="check-memory">Check Memory Usage</button>
      <button id="test-logger">Test Logger</button>
      <button id="test-storage">Test Storage</button>
      <button id="test-navigation">Test Navigation</button>
    </div>
    
    <div class="panel">
      <h2>Component Tests</h2>
      <button id="load-overview">Load Overview Panel</button>
      <button id="load-capture">Load Capture Panel</button>
      <button id="load-knowledge">Load Knowledge Panel</button>
      <button id="load-settings">Load Settings Panel</button>
    </div>
    
    <div id="status-container" class="status">
      <h3>Status</h3>
      <div id="status-message">Ready for diagnostics</div>
    </div>
    
    <div id="result-container" class="panel">
      <h3>Results</h3>
      <pre id="result-output"></pre>
    </div>
  </div>

  <script type="module">
    // First try to import from the standard path
    let DiagnosticTools;
    let importError = null;
    
    async function loadDiagnostics() {
      try {
        // Try to load using the expected path
        const module = await import ('../popup/diagnostics.js')
        DiagnosticTools = module.DiagnosticTools;
        console.log('Successfully loaded diagnostics.js from ./js/utils/');
        initializeDiagnostics();
      } catch (error1) {
        console.warn('Could not load diagnostics.js from ./js/utils/, trying alternative path...', error1);
        importError = error1;
        
        try {
          // Try another possible path
          const module = await import ('../popup/diagnostics.js')
          DiagnosticTools = module.DiagnosticTools;
          console.log('Successfully loaded diagnostics.js from ../dashboard/js/utils/');
          initializeDiagnostics();
        } catch (error2) {
          console.warn('Could not load diagnostics.js from ../dashboard/js/utils/, trying another path...', error2);
          
          // try {
          //   // Try a third possible path
          //   const module = await import ('../popup/diagnostics.js')
          //   DiagnosticTools = module.DiagnosticTools;
          //   console.log('Successfully loaded diagnostics.js from ../shared/utils/');
          //   initializeDiagnostics();
          // } catch (error3) {
          //   console.error('Failed to load DiagnosticTools from any known path', error3);
          //   document.getElementById('status-message').textContent = 'Error: Could not load diagnostic tools';
          //   document.getElementById('status-container').classList.add('error');
          //   document.getElementById('result-output').textContent = `Error loading diagnostic tools:\n${error1}\n${error2}\n${error3}`;
            
          //   // Create a fallback minimal diagnostic tool
          //   createFallbackDiagnostics();
          // }
        }
      }
    }
    
    function createFallbackDiagnostics() {
      // Create a minimal version of DiagnosticTools if we couldn't load it
      class FallbackDiagnosticTools {
        constructor() {
          this.logs = [];
          console.log('Using fallback diagnostic tools');
        }
        
        takeMemorySnapshot() {
          if (performance && performance.memory) {
            return {
              timestamp: Date.now(),
              usedJSHeapSize: performance.memory.usedJSHeapSize,
              totalJSHeapSize: performance.memory.totalJSHeapSize,
              jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
            };
          }
          return null;
        }
        
        async testModuleLoading(modulePath) {
          try {
            const startTime = performance.now();
            const module = await import(modulePath);
            const endTime = performance.now();
            
            return {
              success: true,
              loadTime: endTime - startTime,
              exports: Object.keys(module)
            };
          } catch (error) {
            return {
              success: false,
              error: error.message
            };
          }
        }
      }
      
      DiagnosticTools = FallbackDiagnosticTools;
      initializeDiagnostics();
    }
    
    function initializeDiagnostics() {
      const statusMessage = document.getElementById('status-message');
      const resultOutput = document.getElementById('result-output');
      
      // Initialize diagnostic tools
      const diagnostics = new DiagnosticTools();
      
      function updateStatus(message, isError = false) {
        statusMessage.textContent = message;
        const container = document.getElementById('status-container');
        if (isError) {
          container.classList.add('error');
        } else {
          container.classList.remove('error');
        }
      }
      
      function logResult(message) {
        const timestamp = new Date().toISOString();
        resultOutput.textContent += `[${timestamp}] ${message}\n`;
      }
      
      // Memory check
      document.getElementById('check-memory').addEventListener('click', () => {
        updateStatus('Checking memory usage...');
        
        const snapshot = diagnostics.takeMemorySnapshot();
        
        if (snapshot) {
          const usedHeapMB = Math.round(snapshot.usedJSHeapSize / (1024 * 1024));
          const totalHeapMB = Math.round(snapshot.totalJSHeapSize / (1024 * 1024));
          const heapLimitMB = Math.round(snapshot.jsHeapSizeLimit / (1024 * 1024));
          
          logResult(`Memory Usage: ${usedHeapMB}MB / ${totalHeapMB}MB (Limit: ${heapLimitMB}MB)`);
          updateStatus(`Current memory usage: ${usedHeapMB}MB`);
        } else {
          updateStatus('Performance.memory API not available in this browser', true);
        }
      });
      
      // Test logger
      document.getElementById('test-logger').addEventListener('click', async () => {
        updateStatus('Testing logger...');
        
        try {
          // Try different paths for the logger
          const paths = [
            '../shared/utils/log-manager.js',
            './shared/utils/log-manager.js',
            '../../shared/utils/log-manager.js'
          ];
          
          let success = false;
          
          for (const path of paths) {
            try {
              const result = await diagnostics.testModuleLoading(path);
              
              if (result.success) {
                logResult(`Logger test completed successfully in ${result.loadTime.toFixed(2)}ms`);
                updateStatus('Logger test passed');
                logResult(`Logger path: ${path}`);
                success = true;
                break;
              }
            } catch (e) {
              // Continue to next path
            }
          }
          
          if (!success) {
            throw new Error('Could not load logger from any known path');
          }
        } catch (error) {
          console.error('Logger test error:', error);
          logResult(`Logger test failed: ${error.message}`);
          updateStatus(`Logger test failed: ${error.message}`, true);
        }
      });
      
      // Test storage
      document.getElementById('test-storage').addEventListener('click', async () => {
        updateStatus('Testing storage...');
        
        try {
          // Test chrome.storage.local
          const testData = { test_key: 'test_value', timestamp: Date.now() };
          await chrome.storage.local.set({ 'marvin_test_data': testData });
          
          const result = await chrome.storage.local.get('marvin_test_data');
          
          if (result.marvin_test_data && result.marvin_test_data.test_key === 'test_value') {
            logResult('Storage test completed successfully');
            updateStatus('Storage test passed');
          } else {
            throw new Error('Storage data mismatch');
          }
        } catch (error) {
          console.error('Storage test error:', error);
          logResult(`Storage test failed: ${error.message}`);
          updateStatus(`Storage test failed: ${error.message}`, true);
        }
      });
      
      // Test navigation
      document.getElementById('test-navigation').addEventListener('click', async () => {
        updateStatus('Testing navigation module...');
        
        try {
          // Try different possible paths
          const paths = [
            './js/components/navigation.js',
            '../dashboard/js/components/navigation.js'
          ];
          
          let success = false;
          
          for (const path of paths) {
            try {
              const result = await diagnostics.testModuleLoading(path);
              
              if (result.success) {
                logResult(`Navigation module loaded successfully in ${result.loadTime.toFixed(2)}ms. Available functions: ${result.exports.join(', ')}`);
                updateStatus('Navigation module loaded successfully');
                logResult(`Navigation path: ${path}`);
                success = true;
                break;
              }
            } catch (e) {
              // Continue to next path
            }
          }
          
          if (!success) {
            throw new Error('Could not load navigation module from any known path');
          }
        } catch (error) {
          console.error('Navigation test error:', error);
          logResult(`Navigation test failed: ${error.message}`);
          updateStatus(`Navigation test failed: ${error.message}`, true);
        }
      });
      
      // Check component structure
      async function componentCheck(name, paths) {
        updateStatus(`Loading ${name} panel...`);
        
        try {
          let success = false;
          
          for (const path of paths) {
            try {
              const result = await diagnostics.testModuleLoading(path);
              
              if (result.success) {
                logResult(`${name} panel module loaded successfully in ${result.loadTime.toFixed(2)}ms`);
                updateStatus(`${name} panel loaded successfully`);
                logResult(`${name} path: ${path}`);
                success = true;
                break;
              }
            } catch (e) {
              // Continue to next path
            }
          }
          
          if (!success) {
            throw new Error(`Could not load ${name} panel module from any known path`);
          }
        } catch (error) {
          console.error(`${name} panel load error:`, error);
          logResult(`${name} panel load failed: ${error.message}`);
          updateStatus(`${name} panel load failed: ${error.message}`, true);
        }
      }
      
      // Component test functions
      document.getElementById('load-overview').addEventListener('click', () => {
        componentCheck('Overview', [
          './js/components/overview-panel.js',
          '../dashboard/js/components/overview-panel.js'
        ]);
      });
      
      document.getElementById('load-capture').addEventListener('click', () => {
        componentCheck('Capture', [
          './js/components/capture-panel.js',
          '../dashboard/js/components/capture-panel.js'
        ]);
      });
      
      document.getElementById('load-knowledge').addEventListener('click', () => {
        componentCheck('Knowledge', [
          './js/components/knowledge-panel.js',
          '../dashboard/js/components/knowledge-panel.js'
        ]);
      });
      
      document.getElementById('load-settings').addEventListener('click', () => {
        componentCheck('Settings', [
          './js/components/settings-panel.js',
          '../dashboard/js/components/settings-panel.js'
        ]);
      });
      
      // Initial status
      updateStatus('Diagnostic dashboard loaded successfully');
      logResult('Diagnostic dashboard initialized');
      
      // Log browser information
      const browserInfo = `
Browser: ${navigator.userAgent}
Platform: ${navigator.platform}
Language: ${navigator.language}
Online: ${navigator.onLine}
`;
      logResult(browserInfo);
      
      // Log extension information
      try {
        const manifest = chrome.runtime.getManifest();
        logResult(`Extension: ${manifest.name} v${manifest.version}`);
      } catch (error) {
        logResult('Could not retrieve extension information');
      }
    }
    
    // Start loading diagnostics
    loadDiagnostics();
  </script>  
</body>
</html>